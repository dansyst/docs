## CAM基本原理

### CNN最后一层卷积层

CNN最后一层卷积层输出的特征图是三维的，[C, H, W]

- C是通道数（特征图的数量）
- H是特征图的高度
- W是特征图的宽度

每个通道可以理解为网络学习到的某种特定特征。

- 第k个通道可表示为$f_k(x,y)$，通道可以理解为该通道对应的特征图中，位置$(x,y)$处的激活值（强度）。

- **通道的含义**：每个通道对应网络提取的某种特征。浅层卷积层，通道可能对应一些简单的特征（边缘、纹理）；深层卷积层，通道可能对应更复杂的高级特征（物体的部分或整体形状）

### 全局平均池化

- 对于第 $k$ 个通道，计算所有空间位置$(x,y)$的激活值的平均值：

$$
GAP(f_k) = \frac{1}{H \times W} \sum\limits_{x=1}^H\sum\limits_{y=1}^W f_k(x,y)
$$

### 全连接层的权重

$W$形状为$[N_o,C]$

- $N_o$是输出类别的数量（如果是二分类问题，如，1代表故障，-1代表健康）
- $C$​是最后一个卷积层输出的通道数（可以为每一个通道赋予权重）

例如，对于第 $n$ 个类别，对应的权重向量是 $\omega^n = W[n,:]$，权重矩阵的第 $n$ 行，该权重向量有 $C$ 个元素，每个元素 $\omega_k^n$ 对应第 $k$ 个通道的权重

### 计算置信分数

由最后一个卷积层的输出特征图到输出层中的第 $n$ ​个类别的置信分数（每个类别的置信分数计算都用到了所有通道的激活值，即特征图对该类别的整体响应强度）：
$$
S_n =\sum\limits_{k=1}^C \omega_k^n \sum\limits_{x,y} f_k(x,y)=\sum\limits_{x,y}\sum\limits_{k=1}^C \omega_k^n f_k (x,y)
$$

>  *其中$\sum\limits_{x,y} f_k(x,y)$为全局平均池化$GAP(f_k)$（省略了除以元素总数），全局平均池化的结果是计算结果为$C$个数值，每个值代表着该通道上所有值的平均值。$\omega_k$表示全连接输出层中第$n$类对应的$C$个权重中的第$k$个：即全连接层的权重矩阵 $W$是$[N_o,C]$维的（$N_o$即输出类别数，$C$是最后一层卷积层的输出通道数），那么第$n$类对应的权重$\omega^n$就应该是$W[c,:]$，$w^n_k$有着$C$个权重参数，对应着每个输入值（即全局平均池化的结果)，$w^n_k$就是这$C$个权重参数中的第$k$​个数。*

#### 置信分数计算示例

假设：

- 最后一个卷积层有 $C=3$ 个通道，

- 输出类别数为 $N_o=2$（例如类别 0 和类别 1），

- 全局平均池化的结果是 $[2.0,3.0,1.0]$（即每个通道的平均值），

- 全连接层的权重矩阵$W$为：
  $$
  W = \begin{bmatrix}
  0.5 & 1.0 & -0.2 \\  % 类别 0 的权重
  -0.3 & 0.8 & 0.4     % 类别 1 的权重
  \end{bmatrix}
  $$
  

那么：

- 对于类别 0：

  $S_0=0.5×2.0+1.0×3.0+(−0.2)×1.0=1.0+3.0−0.2=3.8$

- 对于类别 1：

  $S_1=(−0.3)×2.0+0.8×3.0+0.4×1.0=−0.6+2.4+0.4=2.2$

最终，类别 0 的置信分数是 3.8，类别 1 的置信分数是 2.2。

置信分数代表该类别的概率。



### 类激活图CAM

这个公式进一步理解：
$$
\sum\limits_{k=1}^C \omega_k^n f_k (x,y)
$$
表示在每一个空间位置 $(x,y)$ 处，所有通道的**加权和**，也可以理解为在位置$(x,y)$处，与类别$n$相关的特征强度（该类别下所有通道对应的激活值加权后求和）。

### CAM 的意义

- **热力图**：CAM 是一个二维的热力图，**其大小与输入特征图的空间尺寸相同**（通常是最后一个卷积层的输出尺寸）。
- **高亮区域**：热力图中值较大的区域，表示这些区域对预测类别 $n$ 起到了重要作用。
- **可视化**：通过将 CAM **上采样到输入图像的尺寸**，可以直观地看到网络在预测类别  $n$ 时关注了图像的哪些部分。

####  类激活图计算示例

假设：
- 最后一个卷积层的输出特征图是 $[C, H, W]$，其中 $C = 3$（3 个通道），$H = 2$，$W = 2 $。
- 全连接层的权重矩阵 $W$ 是$[N_o, C]$，其中 $N_o=2$（2 个类别），$C=3$。
- 对于类别 $n=0$ ，权重向量 $\omega^0 = [0.5, 1.0, -0.2]$。

#### 特征图示例：

假设特征图的 3 个通道在空间位置 $(x, y)$ 处的值为：
$$
f_1(x, y) = \begin{bmatrix} 1 & 2 \\ 3 & 4 \end{bmatrix}, \quad
f_2(x, y) = \begin{bmatrix} 2 & 3 \\ 4 & 5 \end{bmatrix}, \quad
f_3(x, y) = \begin{bmatrix} 0 & 1 \\ 2 & 3 \end{bmatrix}
$$

#### 计算 CAM：

对每个空间位置 $(x, y)$ $ \sum_k \omega_k^0 f_k(x, y)$：
$\text{CAM}(x, y) = 0.5 \cdot f_1(x, y) + 1.0 \cdot f_2(x, y) + (-0.2) \cdot f_3(x, y)$
具体计算：
$$
\text{CAM} = \begin{bmatrix}
0.5 \cdot 1 + 1.0 \cdot 2 + (-0.2) \cdot 0 & 0.5 \cdot 2 + 1.0 \cdot 3 + (-0.2) \cdot 1 \\
0.5 \cdot 3 + 1.0 \cdot 4 + (-0.2) \cdot 2 & 0.5 \cdot 4 + 1.0 \cdot 5 + (-0.2) \cdot 3
\end{bmatrix}
= \begin{bmatrix}
2.5 & 4.8 \\
6.6 & 8.4
\end{bmatrix}
$$

这个矩阵就是类别 $n=0$ 的激活图 $\text {CAM}$ 。



参考：

[CAM系列（一）之CAM（原理讲解和PyTorch代码实现） - 简书](https://www.jianshu.com/p/fd2f09dc3cc9)

[CAM系列（二）之Grad-CAM（原理讲解和代码实现）zz - 风生水起 - 博客园](https://www.cnblogs.com/end/p/17059350.html)
